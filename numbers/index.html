<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Number Listening</title>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                margin: 0;
                font-family: "Segoe UI", sans-serif;
                background: #fdfaf5; /* warm neutral background */
                color: #333;
                overflow: hidden;
            }

            .container {
                background: #ffffff;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
                text-align: center;
                width: 90%;
                max-width: 500px;
                z-index: 1;
            }

            .controls {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-bottom: 1rem;
                flex-wrap: wrap;
            }

            .controls label {
                font-weight: bold;
                margin-right: 0.3rem;
                color: #5b4d3b;
            }

            .controls select {
                font-size: 1rem;
                padding: 0.4rem;
                min-width: 140px;
                border-radius: 8px;
                border: 1px solid #ccc;
                background: #f4f2ee;
            }

            .language-toggle {
                display: flex;
                align-items: center;
                gap: 0.6rem;
                flex-wrap: wrap;
            }

            .lang-buttons {
                display: flex;
                gap: 0.4rem;
                flex-wrap: wrap;
            }

            .lang-btn {
                padding: 0.35rem 0.9rem;
                border-radius: 8px;
                background: #eee7dc;
                border: 1px solid transparent;
            }

            .lang-btn.active {
                background: #cfc7b8;
                border-color: #b7ac9a;
            }

            .interaction {
                margin-top: 1rem;
            }

            input[type="text"] {
                font-size: 1rem;
                padding: 0.4rem;
                width: 120px;
                text-align: center;
                margin-right: 0.5rem;
                border-radius: 8px;
                border: 1px solid #bbb;
                background: #fdfdfd;
            }

            button {
                font-size: 1.1rem;
                padding: 0.5rem 1.2rem;
                margin: 0.2rem;
                background: #dcd3c4; /* warm beige */
                border: none;
                border-radius: 10px;
                color: #2f2f2f;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            }

            button:hover {
                background: #cfc7b8;
            }

            .inline-play {
                padding: 0.25rem 0.65rem;
                font-size: 0.95rem;
                margin-left: 0.4rem;
            }

            #feedback {
                margin-top: 1rem;
                font-weight: bold;
                min-height: 1.2em;
                color: #6b5e4a;
            }

            #explanation {
                margin-top: 0.3rem;
                color: #8b5e4a;
                min-height: 1.1em;
                font-size: 0.95rem;
            }

            #progressContainer {
                margin-top: 1rem;
                height: 14px;
                background: #eae7e2;
                width: 100%;
                border-radius: 7px;
                overflow: hidden;
                position: relative;
            }

            #progressBar {
                height: 100%;
                width: 0%;
                background: linear-gradient(
                    90deg,
                    #a5a58d,
                    #c3b091
                ); /* moss to tan gradient */
                transition: width 0.3s ease;
            }

            #milestoneText {
                font-size: 0.9rem;
                margin-top: 0.3rem;
                color: #4e4433;
            }
        </style>
    </head>
    <body>
        <div class="container" id="card">
            <h1 id="heading">Number Listening</h1>
            <div class="controls">
                <div class="language-toggle">
                    <div class="lang-buttons">
                        <button
                            class="lang-btn"
                            type="button"
                            data-lang="en"
                            id="langEn"
                        >
                            English
                        </button>
                        <button
                            class="lang-btn"
                            type="button"
                            data-lang="vi"
                            id="langVi"
                        >
                            Tiếng Việt
                        </button>
                    </div>
                </div>
                <div>
                    <label for="digitCount" id="digitLabel"
                        >Number of digits:</label
                    ><select id="digitCount">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div>
                    <label for="rate" id="rateLabel">Rate:</label
                    ><select id="rate">
                        <option value="0.5">0.5×</option>
                        <option value="0.75">0.75×</option>
                        <option value="1" selected>1×</option>
                        <option value="1.25">1.25×</option>
                        <option value="1.5">1.5×</option>
                        <option value="2">2×</option>
                    </select>
                </div>
                <div>
                    <label for="modeSelect" id="modeLabel">Reading mode:</label
                    ><select id="modeSelect">
                        <option value="digits" selected>Digit by digit</option>
                        <option value="full">Full number</option>
                    </select>
                </div>
            </div>
            <p id="prompt">
                Listen to the number sequence and type what you hear:
            </p>
            <div class="interaction">
                <input
                    type="text"
                    id="answer"
                    maxlength="10"
                    autocomplete="off"
                    placeholder="e.g.: 4512"
                />
                <button id="submitBtn">Check</button
                ><button id="replayBtn">Start</button>
            </div>
            <div id="feedback"></div>
            <div id="explanation"></div>
            <div id="progressContainer"><div id="progressBar"></div></div>
            <div id="milestoneText">
                <span id="milestoneLabel">Milestones:</span>
                <span id="seenCount">0</span>
                <span id="milestoneOfLabel">of</span>
                <span id="totalMilestones"></span>
            </div>
            <small id="autoPlayNote"
                >(A new sequence will automatically play after you
                answer.)</small
            >
        </div>

        <script>
            let voices = [],
                currentSequence = [],
                streak = 0,
                seen = new Set();
            const fib = [1, 3, 10, 20, 50, 100, 200, 500];

            const digitCountEl = document.getElementById("digitCount");
            const rateEl = document.getElementById("rate");
            const modeSelect = document.getElementById("modeSelect");
            const answerEl = document.getElementById("answer");
            const submitBtn = document.getElementById("submitBtn");
            const replayBtn = document.getElementById("replayBtn");
            const feedbackEl = document.getElementById("feedback");
            const explanationEl = document.getElementById("explanation");
            const progressBar = document.getElementById("progressBar");
            const seenCountEl = document.getElementById("seenCount");
            const totalMilestonesEl =
                document.getElementById("totalMilestones");
            const languageButtons = Array.from(
                document.querySelectorAll(".lang-btn"),
            );
            const headingEl = document.getElementById("heading");
            const promptEl = document.getElementById("prompt");
            const autoPlayNote = document.getElementById("autoPlayNote");
            const milestoneLabelEl = document.getElementById("milestoneLabel");
            const milestoneOfLabelEl =
                document.getElementById("milestoneOfLabel");
            const digitLabelEl = document.getElementById("digitLabel");
            const rateLabelEl = document.getElementById("rateLabel");
            const modeLabelEl = document.getElementById("modeLabel");
            let selectedVoice = null;

            const translations = {
                en: {
                    title: "Number Listening",
                    heading: "Number Listening",
                    digitLabel: "Number of digits:",
                    rateLabel: "Rate:",
                    modeLabel: "Reading mode:",
                    modes: {
                        digits: "Digit by digit",
                        full: "Full number",
                    },
                    prompt: "Listen to the number sequence and type what you hear:",
                    placeholder: "e.g.: 4512",
                    buttons: {
                        check: "Check",
                        start: "Start",
                        replay: "Replay",
                    },
                    feedback: {
                        correct: "✅ Correct!",
                        incorrect: (answer) =>
                            `❌ Incorrect. Answer: ${answer}`,
                    },
                    explanation: {
                        wrong: (user, answer) =>
                            `You entered ${user ? "'" + user + "'" : "nothing"}. Correct number: ${answer}. Re-listen and try again.`,
                    },
                    milestoneLabel: "Milestones:",
                    of: "of",
                    autoPlay:
                        "(A new sequence will automatically play after you answer.)",
                },
                vi: {
                    title: "Nghe Số",
                    heading: "Nghe Số",
                    digitLabel: "Số chữ số:",
                    rateLabel: "Tốc độ:",
                    modeLabel: "Cách đọc:",
                    modes: {
                        digits: "Đọc từng số",
                        full: "Đọc cả số",
                    },
                    prompt: "Hãy nghe dãy số và nhập lại:",
                    placeholder: "vd: 4512",
                    buttons: {
                        check: "Kiểm tra",
                        start: "Bắt đầu",
                        replay: "Nghe lại",
                    },
                    feedback: {
                        correct: "✅ Chính xác!",
                        incorrect: (answer) => `❌ Sai. Đáp án: ${answer}`,
                    },
                    explanation: {
                        wrong: (user, answer) =>
                            `Bạn nhập ${user ? "'" + user + "'" : "trống"}. Đáp án đúng: ${answer}. Hãy nghe lại và thử lần nữa.`,
                    },
                    milestoneLabel: "Mốc:",
                    of: "trên",
                    autoPlay: "(Dãy số mới sẽ tự phát sau khi bạn trả lời.)",
                },
            };

            const defaultLang = navigator.language.startsWith("vi")
                ? "vi"
                : "en";
            let currentLanguage = defaultLang;
            let hasStarted = false;

            totalMilestonesEl.textContent = fib.length;

            function updateLanguageButtons(lang) {
                languageButtons.forEach((btn) =>
                    btn.classList.toggle("active", btn.dataset.lang === lang),
                );
            }

            function applyTranslations(lang) {
                const t = translations[lang] || translations.en;
                currentLanguage = lang;
                document.documentElement.lang = lang;
                document.title = t.title;
                headingEl.textContent = t.heading;
                digitLabelEl.textContent = t.digitLabel;
                rateLabelEl.textContent = t.rateLabel;
                modeLabelEl.textContent = t.modeLabel;
                modeSelect.options[0].textContent = t.modes.digits;
                modeSelect.options[1].textContent = t.modes.full;
                promptEl.textContent = t.prompt;
                answerEl.placeholder = t.placeholder;
                submitBtn.textContent = t.buttons.check;
                replayBtn.textContent = hasStarted
                    ? t.buttons.replay
                    : t.buttons.start;
                milestoneLabelEl.textContent = t.milestoneLabel;
                milestoneOfLabelEl.textContent = t.of;
                autoPlayNote.textContent = t.autoPlay;
                explanationEl.textContent = "";
            }

            function resetResultsAndMedia() {
                feedbackEl.textContent = "";
                explanationEl.textContent = "";
                answerEl.value = "";
                waitingForAnswer = false;
            }

            function getVoiceByLangPrefix(prefix) {
                const lowerPrefix = prefix.toLowerCase();
                return (
                    voices.find((voice) =>
                        (voice.lang || "")
                            .toLowerCase()
                            .startsWith(lowerPrefix),
                    ) || null
                );
            }

            function getPreferredEnglishVoice() {
                if (!voices.length) return null;
                const preferredNames = [
                    "samantha",
                    "alex",
                    "allison",
                    "ava",
                    "karen",
                ];
                const enVoices = voices.filter((voice) =>
                    (voice.lang || "").toLowerCase().startsWith("en"),
                );
                const byName =
                    enVoices.find((v) =>
                        preferredNames.some((n) =>
                            (v.name || "").toLowerCase().includes(n),
                        ),
                    ) || null;
                const usVoice =
                    enVoices.find((v) =>
                        (v.lang || "").toLowerCase().startsWith("en-us"),
                    ) || null;
                return byName || usVoice || enVoices[0] || null;
            }

            function speakUserInput(value) {
                if (!value) return;
                const utter = new SpeechSynthesisUtterance(
                    value.split("").join(" "),
                );
                if (selectedVoice) utter.voice = selectedVoice;
                utter.rate = parseFloat(rateEl.value);
                speechSynthesis.speak(utter);
            }

            function cacheVoices() {
                voices = speechSynthesis.getVoices();
                if (!voices.length) return;
                const target = currentLanguage === "vi" ? "en" : "vi";
                if (target === "en") {
                    selectedVoice =
                        getPreferredEnglishVoice() ||
                        getVoiceByLangPrefix(target) ||
                        voices[0] ||
                        null;
                } else {
                    selectedVoice =
                        getVoiceByLangPrefix(target) || voices[0] || null;
                }
            }

            function loadVoices() {
                cacheVoices();
                if (!voices.length) speechSynthesis.onvoiceschanged = cacheVoices;
            }

            let waitingForAnswer = false;

            function numberToEnglish(n) {
                const ones = [
                    "",
                    "one",
                    "two",
                    "three",
                    "four",
                    "five",
                    "six",
                    "seven",
                    "eight",
                    "nine",
                    "ten",
                    "eleven",
                    "twelve",
                    "thirteen",
                    "fourteen",
                    "fifteen",
                    "sixteen",
                    "seventeen",
                    "eighteen",
                    "nineteen",
                ];
                const tens = [
                    "",
                    "",
                    "twenty",
                    "thirty",
                    "forty",
                    "fifty",
                    "sixty",
                    "seventy",
                    "eighty",
                    "ninety",
                ];
                const words = [];
                if (n >= 1000) {
                    words.push(
                        numberToEnglish(Math.floor(n / 1000)) + " thousand",
                    );
                    n %= 1000;
                }
                if (n >= 100) {
                    words.push(ones[Math.floor(n / 100)] + " hundred");
                    n %= 100;
                }
                if (n >= 20)
                    words.push(
                        tens[Math.floor(n / 10)] +
                            (n % 10 ? " " + ones[n % 10] : ""),
                    );
                else if (n > 0) words.push(ones[n]);
                return words.join(" ");
            }

            function numberToVietnamese(n) {
                if (Number.isNaN(n)) return "";
                if (n === 0) return "không";
                const ones = [
                    "không",
                    "một",
                    "hai",
                    "ba",
                    "bốn",
                    "năm",
                    "sáu",
                    "bảy",
                    "tám",
                    "chín",
                ];

                function readUnderHundred(num) {
                    if (num < 10) return ones[num];
                    if (num < 20) {
                        if (num === 10) return "mười";
                        if (num === 15) return "mười lăm";
                        return `mười ${num === 11 ? "một" : ones[num % 10]}`;
                    }
                    const tensDigit = Math.floor(num / 10);
                    const unit = num % 10;
                    let unitWord = ones[unit];
                    if (unit === 1) unitWord = "mốt";
                    else if (unit === 5) unitWord = "lăm";
                    const tensWord = `${ones[tensDigit]} mươi`;
                    return unit ? `${tensWord} ${unitWord}` : tensWord;
                }

                function readHundreds(num, forceHundreds = false) {
                    const hundred = Math.floor(num / 100);
                    const rest = num % 100;
                    const parts = [];
                    if (hundred || forceHundreds) {
                        parts.push(
                            hundred ? `${ones[hundred]} trăm` : "không trăm",
                        );
                    }
                    if (rest) {
                        if (rest < 10) {
                            if (hundred || forceHundreds) {
                                parts.push("lẻ");
                                parts.push(rest === 5 ? "năm" : ones[rest]);
                            } else {
                                parts.push(ones[rest]);
                            }
                        } else {
                            parts.push(readUnderHundred(rest));
                        }
                    }
                    return parts.join(" ").trim();
                }

                const thousands = Math.floor(n / 1000);
                const remainder = n % 1000;
                const parts = [];
                if (thousands) {
                    if (thousands >= 100) parts.push(readHundreds(thousands));
                    else if (thousands >= 10)
                        parts.push(readUnderHundred(thousands));
                    else parts.push(ones[thousands]);
                    parts.push("nghìn");
                }
                if (remainder)
                    parts.push(readHundreds(remainder, Boolean(thousands)));
                return parts.join(" ").trim();
            }

            function numberToWords(n, lang) {
                if (lang === "vi") return numberToVietnamese(n);
                return numberToEnglish(n);
            }

            function speakSequence() {
                if (!currentSequence.length) return;
                const numberString = currentSequence.join("");
                const text =
                    modeSelect.value === "full"
                        ? numberToWords(
                              parseInt(numberString, 10),
                              currentLanguage,
                          ) || numberString
                        : currentSequence.join(" ");
                const utter = new SpeechSynthesisUtterance(text);
                if (selectedVoice) utter.voice = selectedVoice;
                utter.rate = parseFloat(rateEl.value);
                speechSynthesis.speak(utter);
            }

            function nextQuestion() {
                if (waitingForAnswer) return;
                waitingForAnswer = true;

                // keep feedback/explanation so previous result remains visible
                answerEl.value = "";
                const n = parseInt(digitCountEl.value);
                currentSequence = Array.from({ length: n }, () =>
                    Math.floor(Math.random() * 10),
                );
                speakSequence();
            }

            function updateProgress() {
                // Find the milestone streak just below or equal to current
                const prevMilestone =
                    [...fib].reverse().find((m) => m <= streak) || 0;
                const nextMilestone =
                    fib.find((m) => m > streak) || prevMilestone;

                const range = nextMilestone - prevMilestone || 1;
                const progress = (streak - prevMilestone) / range;

                progressBar.style.width = `${(progress * 100).toFixed(1)}%`;
                seenCountEl.textContent = seen.size;
            }

            function checkAnswer() {
                if (!waitingForAnswer) return; // prevent double submits
                waitingForAnswer = false;

                const user = answerEl.value.trim();
                const correct = currentSequence.join("");

                if (user === correct) {
                    streak++;
                    feedbackEl.textContent =
                        translations[currentLanguage].feedback.correct;
                    explanationEl.textContent = "";

                    if (fib.includes(streak)) seen.add(streak);
                    nextQuestion();
                } else {
                    feedbackEl.textContent =
                        "Your answer is not correct. You put:";
                    explanationEl.textContent = "";
                    const playBtn = document.createElement("button");
                    playBtn.type = "button";
                    playBtn.textContent = "▶ Play";
                    playBtn.classList.add("inline-play");
                    playBtn.addEventListener("click", () =>
                        speakUserInput(user),
                    );
                    feedbackEl.appendChild(playBtn);
                    streak = 0; // reset streak
                    waitingForAnswer = true; // let user guess again on same number
                }

                updateProgress();
            }

            window.addEventListener("load", () => {
                loadVoices();
                setTimeout(() => {
                    waitingForAnswer = false;
                    nextQuestion();
                }, 80); // 20% faster
            });
            applyTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            languageButtons.forEach((btn) =>
                btn.addEventListener("click", () => {
                    applyTranslations(btn.dataset.lang);
                    updateLanguageButtons(btn.dataset.lang);
                    cacheVoices();
                    resetResultsAndMedia();
                    nextQuestion();
                }),
            );

            replayBtn.onclick = () => {
                if (!hasStarted) {
                    hasStarted = true;
                    replayBtn.textContent =
                        translations[currentLanguage].buttons.replay;
                }
                speakSequence();
            };
            submitBtn.onclick = checkAnswer;
            answerEl.addEventListener("keydown", (e) => {
                if (e.key === "Enter") checkAnswer();
            });
            [digitCountEl, rateEl, modeSelect].forEach(
                (el) => (el.onchange = nextQuestion),
            );
        </script>
    </body>
</html>
